!function(s){s.fn.timeSchedule=function(i){this.calcStringTime=function(i){var e=i.split(":");return 60*Number(e[0])*60+60*Number(e[1])},this.formatTime=function(i){return""+(i/36e3|0)+(i/3600%10|0)+":"+(""+(i%3600/600|0)+(i%3600/60%10|0))};var p=s.extend({rows:{},startTime:"07:00",endTime:"19:30",widthTimeX:25,widthTime:600,timeLineY:50,timeLineBorder:1,timeBorder:1,timeLinePaddingTop:0,timeLinePaddingBottom:0,headTimeBorder:1,dataWidth:160,verticalScrollbar:0,bundleMoveWidth:1,init_data:null,change:null,click:null,append:null,time_click:null,debug:""},i);this.setting=p;var u=new Array,v=new Array,T=s(this),w=this,_=w.calcStringTime(p.startTime),g=w.calcStringTime(p.endTime),l=null;return _-=_%p.widthTime,g-=g%p.widthTime,this.getScheduleData=function(){return u},this.getTimelineData=function(){return v},this.getTimeLineNumber=function(i){var e=0,t=0,n=Math.ceil(i/(p.timeLineY+p.timeLinePaddingTop+p.timeLinePaddingBottom));for(var a in p.rows){var d=p.rows[a],s=0;if(typeof d.schedule==Object&&(s=d.schedule.length),l&&l.timeline&&s++,n<=(t+=Math.max(s,1)))break;e++}return e},this.addScheduleBgData=function(i){var e=Math.ceil((i.start-_)/p.widthTime),t=Math.floor((i.end-_)/p.widthTime),n=jQuery('<div class="sc_bgBar"><span class="text"></span></div>');w.formatTime(i.start),w.formatTime(i.end),w.getScheduleCount(i.timeline);n.css({left:e*p.widthTimeX,top:0,width:(t-e)*p.widthTimeX,height:T.find(".sc_main .timeline").eq(i.timeline).height()}),i.text&&n.find(".text").text(i.text),i.class&&n.addClass(i.class),T.find(".sc_main .timeline").eq(i.timeline).append(n)},this.addScheduleData=function(i){var e=Math.ceil((i.start-_)/p.widthTime),t=Math.floor((i.end-_)/p.widthTime),n=jQuery('<div class="sc_Bar"><span class="head"><span class="time"></span></span><span class="text"></span></div>'),a=w.formatTime(i.start),d=w.formatTime(i.end),s=w.getScheduleCount(i.timeline);n.css({left:e*p.widthTimeX,top:s*p.timeLineY+p.timeLinePaddingTop,width:(t-e)*p.widthTimeX,height:p.timeLineY}),n.find(".time").text(a+"-"+d),i.text&&n.find(".text").text(i.text),i.class&&n.addClass(i.class),T.find(".sc_main .timeline").eq(i.timeline).append(n),u.push(i);var r=u.length-1;n.data("sc_key",r),n.bind("mouseup",function(){if(p.click&&!0!==jQuery(this).data("dragCheck")&&!0!==jQuery(this).data("resizeCheck")){var i=jQuery(this),e=i.data("sc_key");p.click(i,u[e])}});var o=T.find(".sc_Bar");return o.draggable({grid:[p.widthTimeX,1],containment:".sc_main",helper:"original",start:function(i,e){var t={};t.node=this,t.offsetTop=e.position.top,t.offsetLeft=e.position.left,t.currentTop=e.position.top,t.currentLeft=e.position.left,t.timeline=w.getTimeLineNumber(e.position.top),t.nowTimeline=t.timeline,l=t},drag:function(i,e){if(jQuery(this).data("dragCheck",!0),!l)return!1;var t=jQuery(this),n=t.data("sc_key"),a=(e.originalPosition.top,e.originalPosition.left,e.position.top,e.position.left,w.getTimeLineNumber(e.position.top));return e.position.left=Math.floor(e.position.left/p.widthTimeX)*p.widthTimeX,l.nowTimeline!=a&&(l.nowTimeline=a),l.currentTop=e.position.top,l.currentLeft=e.position.left,w.rewriteBarText(t,u[n]),!0},stop:function(i,e){jQuery(this).data("dragCheck",!1),l=null;var t=jQuery(this),n=t.data("sc_key"),a=t.position().left,d=(t.width(),_+Math.floor(a/p.widthTimeX)*p.widthTime),s=d+(u[n].end-u[n].start);u[n].start=d,u[n].end=s,p.change&&p.change(t,u[n])}}),o.resizable({handles:"e",grid:[p.widthTimeX,p.timeLineY],minWidth:p.widthTimeX,start:function(i,e){jQuery(this).data("resizeCheck",!0)},stop:function(i,e){var t=jQuery(this),n=t.data("sc_key"),a=t.position().left,d=t.width(),s=_+Math.floor(a/p.widthTimeX)*p.widthTime,r=_+Math.floor((a+d)/p.widthTimeX)*p.widthTime,o=u[n].timeline;u[n].start=s,u[n].end=r,w.resetBarPosition(o),w.rewriteBarText(t,u[n]),t.data("resizeCheck",!1),p.change&&p.change(t,u[n])}}),r},this.getScheduleCount=function(i){var e=0;for(var t in u)u[t].timeline==i&&e++;return e},this.addRow=function(i,e){var t,n=e.title,a=T.find(".sc_main .timeline").length;t="",t+='<div class="timeline"><span>'+n+"</span></div>";var d=jQuery(t);p.init_data&&p.init_data(d,e),T.find(".sc_data_scroll").append(d),t="",t+='<div class="timeline"></div>';for(var s=jQuery(t),r=_;r<g;r+=p.widthTime){var o=jQuery('<div class="tl"></div>');o.width(p.widthTimeX-p.timeBorder),o.data("time",w.formatTime(r)),o.data("timeline",i),s.append(o)}if(s.find(".tl").click(function(){w.moveSchedules(jQuery(this).data("timeline"),jQuery(this),p.bundleMoveWidth),p.time_click&&p.time_click(this,jQuery(this).data("time"),jQuery(this).data("timeline"),v[jQuery(this).data("timeline")])}),s.find(".tl").on("contextmenu",function(i){return w.moveSchedules(jQuery(this).data("timeline"),jQuery(this),-1*p.bundleMoveWidth),p.time_click&&p.time_click(this,jQuery(this).data("time"),jQuery(this).data("timeline"),v[jQuery(this).data("timeline")]),!1}),T.find(".sc_main").append(s),(v[i]=e).class&&""!=e.class&&(T.find(".sc_data .timeline").eq(a).addClass(e.class),T.find(".sc_main .timeline").eq(a).addClass(e.class)),e.schedule)for(var l in e.schedule){var c=e.schedule[l],h=w.calcStringTime(c.start),m=w.calcStringTime(c.end),f={};f.timeline=a,f.start=h,f.end=m,c.text&&(f.text=c.text),f.data={},c.data&&(f.data=c.data),w.addScheduleData(f)}w.resetBarPosition(a),T.find(".sc_main .timeline").eq(a).droppable({accept:".sc_Bar",drop:function(i,e){var t=e.draggable,n=t.data("sc_key"),a=u[n].timeline,d=T.find(".sc_main .timeline").index(this);u[n].timeline=d,t.appendTo(this),w.resetBarPosition(a),w.resetBarPosition(d)}}),p.append&&T.find(".sc_main .timeline").eq(a).find(".sc_Bar").each(function(){var i=jQuery(this),e=i.data("sc_key");p.append(i,u[e])})},this.getScheduleData=function(){var i=new Array;for(var e in v)if(void 0!==v[e]){var t=jQuery.extend(!0,{},v[e]);t.schedule=new Array,i.push(t)}for(var e in u)if(void 0!==u[e]){var n=jQuery.extend(!0,{},u[e]);n.start=this.formatTime(n.start),n.end=this.formatTime(n.end);var a=n.timeline;delete n.timeline,i[a].schedule.push(n)}return i},this.rewriteBarText=function(i,e){var t=i.position().left,n=(i.width(),_+Math.floor(t/p.widthTimeX)*p.widthTime),a=n+(e.end-e.start),d=w.formatTime(n)+"-"+w.formatTime(a);jQuery(i).find(".time").html(d)},this.resetBarPosition=function(i){for(var e=T.find(".sc_main .timeline").eq(i).find(".sc_Bar"),t=[],n=0;n<e.length;n++)t[n]={code:n,x:jQuery(e[n]).position().left};t.sort(function(i,e){return i.x<e.x?-1:i.x>e.x?1:0});var a,d,s,r,o,l,c,h=[],m=0;for(n=0;n<t.length;n++){for(s=t[n].code,a=jQuery(e[s]),m=0;m<h.length;m++){for(var f=!1,u=0;u<h[m].length;u++)r=h[m][u],d=jQuery(e[r]),o=a.position().left,l=a.position().left+a.width(),c=d.position().left,o<d.position().left+d.width()&&c<l&&(f=!0);if(!f)break}h[m]||(h[m]=[]),a.css({top:m*p.timeLineY+p.timeLinePaddingTop}),h[m][h[m].length]=s}this.resizeRow(i,h.length)},this.resizeRow=function(i,e){var t=Math.max(e,1);T.find(".sc_data .timeline").eq(i).height(t*p.timeLineY-p.timeLineBorder+p.timeLinePaddingTop+p.timeLinePaddingBottom),T.find(".sc_main .timeline").eq(i).height(t*p.timeLineY-p.timeLineBorder+p.timeLinePaddingTop+p.timeLinePaddingBottom),T.find(".sc_main .timeline").eq(i).find(".sc_bgBar").each(function(){jQuery(this).height(jQuery(this).closest(".timeline").height())}),T.find(".sc_data").height(T.find(".sc_main_box").height())},this.resizeWindow=function(){var i=T.width()-p.dataWidth-p.verticalScrollbar,e=Math.floor((g-_)/p.widthTime);T.find(".sc_header_cell").width(p.dataWidth),T.find(".sc_data,.sc_data_scroll").width(p.dataWidth),T.find(".sc_header").width(i),T.find(".sc_main_box").width(i),T.find(".sc_header_scroll").width(p.widthTimeX*e),T.find(".sc_main_scroll").width(p.widthTimeX*e)},this.moveSchedules=function(i,e,t){for(var n=T.find(".sc_main .timeline").eq(i).find(".sc_Bar"),a=0;a<n.length;a++){var d=jQuery(n[a]);if(e.position().left<=d.position().left){d.css({left:Math.max(0,Math.min(d.position().left+p.widthTimeX*t,Math.floor((g-_)/p.widthTime)*p.widthTimeX-d.width()))});var s=d.data("sc_key"),r=_+Math.floor(d.position().left/p.widthTimeX)*p.widthTime,o=r+(u[s].end-u[s].start);u[s].start=r,u[s].end=o,w.rewriteBarText(d,u[s]),p.change&&p.change(d,u[s])}}w.resetBarPosition(i)},this.init=function(){var i="";i+='<div class="sc_menu">\n',i+='<div class="sc_header_cell"><span>&nbsp;</span></div>\n',i+='<div class="sc_header">\n',i+='<div class="sc_header_scroll">\n',i+="</div>\n",i+="</div>\n",i+='<br class="clear" />\n',i+="</div>\n",i+='<div class="sc_wrapper">\n',i+='<div class="sc_data">\n',i+='<div class="sc_data_scroll">\n',i+="</div>\n",i+="</div>\n",i+='<div class="sc_main_box">\n',i+='<div class="sc_main_scroll">\n',i+='<div class="sc_main">\n',i+="</div>\n",i+="</div>\n",i+="</div>\n",i+='<br class="clear" />\n',i+="</div>\n",T.append(i),T.find(".sc_main_box").scroll(function(){T.find(".sc_data_scroll").css("top",-1*s(this).scrollTop()),T.find(".sc_header_scroll").css("left",-1*s(this).scrollLeft())});for(var e=Math.floor((g-_)/p.widthTime),t=-1,n=_;n<g;n+=p.widthTime)if(t<0||Math.floor(t/3600)!=Math.floor(n/3600)){i="";i+='<div class="sc_time">'+w.formatTime(n)+"</div>";var a=jQuery(i);e=Math.floor(Number(Math.min(3600*Math.ceil((n+p.widthTime)/3600),g)-n)/p.widthTime);a.width(e*p.widthTimeX-p.headTimeBorder),T.find(".sc_header_scroll").append(a),t=n}for(var d in jQuery(window).resize(function(){w.resizeWindow()}).trigger("resize"),p.rows)this.addRow(d,p.rows[d])},this.init(),this.debug=function(){var i="";for(var e in u){i+="<div>",i+=e+" : ";var t=u[e];for(var n in t){i+=n+" "+t[n]}i+="</div>"}jQuery(p.debug).html(i)},p.debug&&""!=p.debug&&setInterval(function(){w.debug()},10),this}}(jQuery);